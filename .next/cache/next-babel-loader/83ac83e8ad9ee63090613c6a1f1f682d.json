{"ast":null,"code":"import { compare } from 'bcrypt';\nimport { sign } from 'jsonwebtoken';\nimport { database } from '../../../middleware/database';\nimport cookie from 'cookie';\nexport default database(async function login(req, res) {\n  if (req.method != 'POST') {\n    res.json({\n      status: 'POST only'\n    });\n    return;\n  }\n\n  const email = req.body.email;\n  const password = req.body.password; //\n  // Validate that parameters were supplied\n  //\n\n  if (!email || email.trim().length == 0 || !password || password.trim().length == 0) {\n    res.json({\n      status: 'Name, email, and password are all required'\n    });\n    return;\n  }\n\n  const db = req.db;\n  const existingUser = await db.collection('users').findOne({\n    \"email\": email\n  });\n\n  if (!existingUser) {\n    res.json({\n      status: 'Unsuccessful login'\n    });\n  } else {\n    compare(password, existingUser.password, function (err, result) {\n      //\n      // result will be true/false\n      //\n      if (!err && result) {\n        //\n        // Create json token here\n        //\n        const claims = {\n          sub: existingUser._id,\n          name: existingUser.name,\n          email: existingUser.email\n        };\n        const jwt = sign(claims, process.env.JWT_SECRET, {\n          expiresIn: '1h'\n        });\n        res.setHeader('Set-Cookie', cookie.serialize('auth', jwt, {\n          httpOnly: true,\n          secure: false,\n          sameSite: 'strict',\n          maxAge: 3600,\n          path: '/'\n        }));\n        res.json({\n          authToken: jwt\n        });\n      } else {\n        res.json({\n          status: 'Oops.  Something went wrong'\n        });\n      }\n    });\n  }\n});","map":{"version":3,"sources":["C:/Dev/Sandbox/next/next-starter/pages/api/user/login.ts"],"names":["compare","sign","database","cookie","login","req","res","method","json","status","email","body","password","trim","length","db","existingUser","collection","findOne","err","result","claims","sub","_id","name","jwt","process","env","JWT_SECRET","expiresIn","setHeader","serialize","httpOnly","secure","sameSite","maxAge","path","authToken"],"mappings":"AAEA,SAASA,OAAT,QAAwB,QAAxB;AACA,SAASC,IAAT,QAAqB,cAArB;AACA,SAASC,QAAT,QAA2C,8BAA3C;AACA,OAAOC,MAAP,MAAmB,QAAnB;AAEA,eAAeD,QAAQ,CAAC,eAAeE,KAAf,CACpBC,GADoB,EAEpBC,GAFoB,EAGtB;AACE,MAAGD,GAAG,CAACE,MAAJ,IAAc,MAAjB,EAAyB;AACrBD,IAAAA,GAAG,CAACE,IAAJ,CAAS;AAACC,MAAAA,MAAM,EAAE;AAAT,KAAT;AACA;AACH;;AAED,QAAMC,KAAa,GAAGL,GAAG,CAACM,IAAJ,CAASD,KAA/B;AACA,QAAME,QAAgB,GAAGP,GAAG,CAACM,IAAJ,CAASC,QAAlC,CAPF,CASE;AACA;AACA;;AACA,MAAI,CAACF,KAAD,IAAUA,KAAK,CAACG,IAAN,GAAaC,MAAb,IAAuB,CAAjC,IAAsC,CAACF,QAAvC,IAAmDA,QAAQ,CAACC,IAAT,GAAgBC,MAAhB,IAA0B,CAAjF,EAAoF;AAChFR,IAAAA,GAAG,CAACE,IAAJ,CAAS;AAAEC,MAAAA,MAAM,EAAE;AAAV,KAAT;AACA;AACH;;AAED,QAAMM,EAAE,GAAGV,GAAG,CAACU,EAAf;AACA,QAAMC,YAAY,GAAG,MAAMD,EAAE,CAACE,UAAH,CAAc,OAAd,EAAuBC,OAAvB,CAA+B;AAAE,aAASR;AAAX,GAA/B,CAA3B;;AAEA,MAAI,CAACM,YAAL,EAAmB;AACfV,IAAAA,GAAG,CAACE,IAAJ,CAAS;AAAEC,MAAAA,MAAM,EAAE;AAAV,KAAT;AACH,GAFD,MAEO;AACHT,IAAAA,OAAO,CAACY,QAAD,EAAWI,YAAY,CAACJ,QAAxB,EAAkC,UAASO,GAAT,EAAcC,MAAd,EAAsB;AAC3D;AACA;AACA;AACA,UAAG,CAACD,GAAD,IAAQC,MAAX,EAAmB;AACf;AACA;AACA;AACA,cAAMC,MAAM,GAAG;AAAEC,UAAAA,GAAG,EAAEN,YAAY,CAACO,GAApB;AAAyBC,UAAAA,IAAI,EAAER,YAAY,CAACQ,IAA5C;AAAkDd,UAAAA,KAAK,EAAEM,YAAY,CAACN;AAAtE,SAAf;AACA,cAAMe,GAAG,GAAGxB,IAAI,CAACoB,MAAD,EAASK,OAAO,CAACC,GAAR,CAAYC,UAArB,EAAiC;AAAEC,UAAAA,SAAS,EAAE;AAAb,SAAjC,CAAhB;AAEAvB,QAAAA,GAAG,CAACwB,SAAJ,CAAc,YAAd,EAA4B3B,MAAM,CAAC4B,SAAP,CAAiB,MAAjB,EAAyBN,GAAzB,EAA8B;AACtDO,UAAAA,QAAQ,EAAE,IAD4C;AAEtDC,UAAAA,MAAM,OAFgD;AAGtDC,UAAAA,QAAQ,EAAE,QAH4C;AAItDC,UAAAA,MAAM,EAAE,IAJ8C;AAKtDC,UAAAA,IAAI,EAAE;AALgD,SAA9B,CAA5B;AAOA9B,QAAAA,GAAG,CAACE,IAAJ,CAAS;AAAE6B,UAAAA,SAAS,EAAEZ;AAAb,SAAT;AACH,OAfD,MAeO;AACHnB,QAAAA,GAAG,CAACE,IAAJ,CAAU;AAACC,UAAAA,MAAM,EAAE;AAAT,SAAV;AACH;AACJ,KAtBM,CAAP;AAuBH;AACJ,CAlDsB,CAAvB","sourcesContent":["import { NextApiRequest, NextApiResponse } from 'next';\r\nimport { MongoClient } from 'mongodb';\r\nimport { compare } from 'bcrypt';\r\nimport { sign } from 'jsonwebtoken';\r\nimport { database, MyNextApiRequest } from '../../../middleware/database';\r\nimport cookie from 'cookie';\r\n\r\nexport default database(async function login(\r\n    req: MyNextApiRequest,\r\n    res: NextApiResponse\r\n) {\r\n    if(req.method != 'POST') {\r\n        res.json({status: 'POST only'});\r\n        return;\r\n    }\r\n\r\n    const email: string = req.body.email;\r\n    const password: string = req.body.password;\r\n\r\n    //\r\n    // Validate that parameters were supplied\r\n    //\r\n    if (!email || email.trim().length == 0 || !password || password.trim().length == 0) {\r\n        res.json({ status: 'Name, email, and password are all required' });\r\n        return;\r\n    }\r\n\r\n    const db = req.db;\r\n    const existingUser = await db.collection('users').findOne({ \"email\": email });\r\n\r\n    if (!existingUser) {\r\n        res.json({ status: 'Unsuccessful login' });\r\n    } else {\r\n        compare(password, existingUser.password, function(err, result) {\r\n            //\r\n            // result will be true/false\r\n            //\r\n            if(!err && result) {\r\n                //\r\n                // Create json token here\r\n                //\r\n                const claims = { sub: existingUser._id, name: existingUser.name, email: existingUser.email };\r\n                const jwt = sign(claims, process.env.JWT_SECRET, { expiresIn: '1h' });\r\n\r\n                res.setHeader('Set-Cookie', cookie.serialize('auth', jwt, {\r\n                    httpOnly: true,\r\n                    secure: process.env.NODE_ENV !== 'development',\r\n                    sameSite: 'strict',\r\n                    maxAge: 3600,\r\n                    path: '/'\r\n                }));\r\n                res.json({ authToken: jwt });\r\n            } else {\r\n                res.json( {status: 'Oops.  Something went wrong'});\r\n            }\r\n        });\r\n    }\r\n});"]},"metadata":{},"sourceType":"module"}